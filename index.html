<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EdiTV</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background: #0f0f0f;
  color: white;
}

/* HEADER */
header {
  position: sticky;
  top: 0;
  z-index: 10;
  background: #0f0f0f;
  border-bottom: 1px solid #222;
  padding: 14px;
  display: flex;
  justify-content: center;
}

.logo {
  font-size: 24px;
  font-weight: 700;
}
.logo span { color: #ff0000; }

/* GRID */
#videos {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 18px;
  padding: 18px;
}

/* CARD */
.video {
  background: #181818;
  border-radius: 16px;
  overflow: hidden;
}

/* PLAYER */
.video-player {
  width: 100%;
  aspect-ratio: 16 / 9;
  background: #000;
}

/* THUMBNAIL */
.thumbnail {
  width: 100%;
  height: 100%;
  object-fit: cover;
  cursor: pointer;
}

/* VIDEO */
video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

/* INFO */
.video-info {
  padding: 12px;
}

.video-title {
  font-size: 15px;
  font-weight: 600;
  margin: 0;
}

.video-meta {
  font-size: 13px;
  color: #aaa;
  margin-top: 4px;
}
</style>
</head>

<body>

<header>
  <div class="logo">Edi<span>TV</span></div>
</header>

<div id="videos"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const supabaseClient = supabase.createClient(
  "https://fdwzqfufmnuuerbocwys.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkd3pxZnVmbW51dWVyYm9jd3lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5MjMzMTksImV4cCI6MjA4MjQ5OTMxOX0.v1lFWEyX3fuYL8riWa6D3s3zELn2pskeTJyg-63tWdE"
);

const videosDiv = document.getElementById("videos");

/* TIME AGO */
function timeAgo(date) {
  const s = Math.floor((Date.now() - new Date(date)) / 1000);
  const m = [[31536000,"year"],[2592000,"month"],[86400,"day"],[3600,"hour"],[60,"minute"]];
  for (const [t,l] of m) {
    const v = Math.floor(s/t);
    if (v >= 1) return `${v} ${l}${v>1?"s":""} ago`;
  }
  return "Just now";
}

/* EXTRACT THUMBNAIL */
function extractThumbnail(videoUrl, imgEl) {
  const video = document.createElement("video");
  video.src = videoUrl;
  video.crossOrigin = "anonymous";
  video.preload = "metadata";
  video.muted = true;

  video.onloadedmetadata = () => {
    video.currentTime = Math.min(0.5, video.duration / 2);
  };

  video.onseeked = () => {
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);
    imgEl.src = canvas.toDataURL("image/jpeg", 0.7);
    video.remove();
  };
}

/* PLAY VIDEO */
function playVideo(container, url) {
  container.innerHTML = `
    <video controls autoplay playsinline>
      <source src="${url}">
    </video>
  `;
}

/* LOAD VIDEOS */
async function loadVideos() {
  const { data } = await supabaseClient
    .from("videos")
    .select("*")
    .order("created_at", { ascending: false });

  videosDiv.innerHTML = "";

  data.forEach(v => {
    const id = "thumb_" + Math.random().toString(36).slice(2);

    videosDiv.innerHTML += `
      <div class="video">
        <div class="video-player" id="${id}_container">
          <img id="${id}" class="thumbnail">
        </div>
        <div class="video-info">
          <p class="video-title">${v.title}</p>
          <div class="video-meta">${timeAgo(v.created_at)}</div>
        </div>
      </div>
    `;

    const img = document.getElementById(id);
    extractThumbnail(v.url, img);
    img.onclick = () => playVideo(document.getElementById(id + "_container"), v.url);
  });
}

loadVideos();
</script>

</body>
</html>
