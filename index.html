<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MiniTube</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#0f0f0f; color:white;}
header {padding:12px 24px; display:flex; align-items:center; justify-content:space-between; background:#181818;}
header h1{margin:0; font-size:24px;}
#uploadBox{padding:12px 24px; display:flex; gap:12px; align-items:center;}
#uploadBox input[type="text"], #uploadBox input[type="file"]{flex:1; padding:10px; border-radius:6px; border:none;}
#uploadBox button{background:red; color:white; font-weight:bold; padding:10px 20px; border-radius:6px; border:none; cursor:pointer;}
#statusMessage{margin:8px 24px; color:yellow; font-weight:bold;}
#videos{display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:16px; padding:12px 24px;}
.video{background:#181818; border-radius:10px; overflow:hidden; padding:8px; text-align:center;}
.video h3{margin:0 0 8px 0; font-size:16px;}
.video img{width:100%; border-radius:8px; cursor:pointer;}
.video video{width:100%; display:none; border-radius:8px;}
@media (max-width:768px){
  header{flex-direction:column; align-items:flex-start;}
  #uploadBox{flex-direction:column; gap:8px; padding:12px;}
  #videos{display:flex; flex-direction:column; padding:12px;}
  .video h3{font-size:14px;}
}
</style>
</head>
<body>

<header><h1>MiniTube</h1></header>

<div id="uploadBox">
  <input id="title" type="text" placeholder="Video title">
  <input id="file" type="file" accept="video/*">
  <button onclick="upload()">Upload</button>
</div>

<div id="statusMessage"></div>
<div id="videos"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseClient = supabase.createClient(
  "https://fdwzqfufmnuuerbocwys.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCj…(your key)…"
);

const fileInput = document.getElementById("file");
const titleInput = document.getElementById("title");
const videosDiv = document.getElementById("videos");
const statusMessage = document.getElementById("statusMessage");

function sanitize(name){
  return name.normalize("NFD").replace(/[\u0300-\u036f]/g,"")
             .replace(/\s+/g,"_").replace(/[^a-zA-Z0-9_.-]/g,"");
}

// Load videos
async function load(){
  const {data, error} = await supabaseClient.from("videos").select("*").order("created_at",{ascending:false});
  if(error){ videosDiv.innerText = error.message; return; }
  videosDiv.innerHTML = "";
  data.forEach(v=>{
    videosDiv.innerHTML += `
      <div class="video">
        <h3>${v.title}</h3>
        <img src="${v.thumbnail_url}" onclick="playVideo(this, '${v.url}')">
        <video controls src="${v.url}"></video>
      </div>
    `;
  });
}

// Play video
function playVideo(img, videoUrl){
  const container = img.parentElement;
  const video = container.querySelector('video');
  img.style.display = 'none';
  video.style.display = 'block';
  video.play();
}

// Upload video + auto-generate thumbnail
async function upload(){
  const file = fileInput.files[0];
  const title = titleInput.value.trim();
  if(!file || !title){
    statusMessage.innerText = "⚠️ Please select a file and enter a title";
    return;
  }

  statusMessage.innerText = "⏳ Generating thumbnail and uploading...";

  const fileName = Date.now() + "_" + sanitize(file.name);
  const thumbName = "thumb_" + fileName;

  // Generate thumbnail in browser
  const videoEl = document.createElement('video');
  videoEl.src = URL.createObjectURL(file);
  await new Promise(resolve => videoEl.onloadeddata = resolve);
  const canvas = document.createElement('canvas');
  canvas.width = 320;
  canvas.height = videoEl.videoHeight / (videoEl.videoWidth / 320);
  canvas.getContext('2d').drawImage(videoEl, 0, 0, canvas.width, canvas.height);
  const blobThumb = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.7));

  // Upload video
  const { error: uploadError } = await supabaseClient.storage.from("Video").upload(fileName, file, { upsert:false });
  if(uploadError){ statusMessage.innerText = "❌ Upload error: "+uploadError.message; return; }

  // Upload thumbnail
  const { error: thumbError } = await supabaseClient.storage.from("Video").upload(thumbName, blobThumb, { upsert:false });
  if(thumbError){ statusMessage.innerText = "❌ Thumbnail upload error: "+thumbError.message; return; }

  // Get public URLs
  const { data: videoData } = supabaseClient.storage.from("Video").getPublicUrl(fileName);
  const { data: thumbData } = supabaseClient.storage.from("Video").getPublicUrl(thumbName);

  // Insert into DB
  const { error: insertError } = await supabaseClient.from("videos").insert({
    title,
    url: videoData.publicUrl,
    thumbnail_url: thumbData.publicUrl
  });
  if(insertError){ statusMessage.innerText = "❌ DB error: "+insertError.message; return; }

  statusMessage.innerText = "✅ Upload successful!";
  fileInput.value = "";
  titleInput.value = "";
  load();
}

// Load videos on page load
load();
</script>
</body>
</html>
